<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time Tracker - Worker & Manager Portal</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Flatpickr CSS -->
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
    /* === Code 1 Styling === */

    /* Base and fonts */
    :root {
      --primary: #2f54eb;
      --secondary: #f5f5f5;
      --highlight: #fa541c;
      --black: #1a1a1a;
      --white: #fff;
    }

    * {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: var(--secondary);
      color: var(--black);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header (Code 1) */
    header {
      background-color: var(--primary);
      color: var(--white);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    header .logo {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 1px;
      user-select: none;
    }

    header nav a {
      color: var(--white);
      margin-left: 1.5rem;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s ease;
      cursor: pointer;
    }

    header nav a:hover {
      color: var(--highlight);
    }

    /* Main content */
    main {
      flex-grow: 1;
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    /* Footer (Code 1) */
    footer {
      background-color: var(--primary);
      color: var(--white);
      text-align: center;
      padding: 1rem 0;
      user-select: none;
      font-weight: 600;
    }

    /* === Code 2 Styling & overrides === */
    .hide {
      display: none !important;
    }

    /* Modal styling */
    #projectModal.modal {
      display: none;
      background-color: rgba(0, 0, 0, 0.5);
      position: fixed;
      inset: 0;
      z-index: 1050;
      overflow-y: auto;
      padding: 60px 10px 10px 10px;
    }
    #projectModal .modal-dialog {
      max-width: 500px;
      margin: auto;
    }
    #projectModal .modal-content {
      padding: 1rem 1.5rem;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
    }

    /* Form adjustments */
    #entryForm textarea {
      resize: vertical;
    }

    /* Table responsiveness */
    table {
      background: white;
      border-radius: 6px;
    }

    /* Buttons */
    button {
      user-select: none;
    }

    /* Responsive fixes */
    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      header nav {
        margin-top: 0.5rem;
      }
      header nav a {
        margin-left: 0.5rem;
      }
      main {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>

  <!-- Header from Code 1 -->
  <header>
    <div class="logo">Time Tracker App</div>
    <nav id="mainNav" class="d-none d-md-flex">
      <!-- We won't use these nav links because app has its own pages -->
      <!-- We'll add logout links dynamically -->
    </nav>
  </header>

  <main>
    <!-- === Code 2 App Content === -->

    <!-- Landing Page -->
    <div id="landingPage" class="container text-center">
      <h2 class="mb-4">Login as</h2>
      <div class="d-flex justify-content-center gap-3">
        <button class="btn btn-primary btn-lg" onclick="enterAs('worker')">Worker</button>
        <button class="btn btn-secondary btn-lg" onclick="enterAs('manager')">Manager</button>
      </div>
    </div>

    <!-- Worker Page -->
    <div id="workerPage" class="hide container">
      <h3 class="mb-3">Worker Dashboard</h3>

      <!-- Filters Section -->
      <div class="row g-2 align-items-end mb-3">
        <div class="col-md-3">
          <input type="text" class="form-control" id="searchProject" placeholder="Search Project Title" />
        </div>
        <div class="col-md-2">
          <select class="form-select" id="filterWorkStatus" aria-label="Filter by Work Status">
            <option value="">All Work Status</option>
            <option value="Completed">Completed</option>
            <option value="In Progress">In Progress</option>
            <option value="Pending Review">Pending Review</option>
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select" id="filterApprovalStatus" aria-label="Filter by Approval Status">
            <option value="">All Approval Status</option>
            <option value="Approved">Approved</option>
            <option value="Pending">Pending</option>
          </select>
        </div>
        <div class="col-md-3">
          <input type="text" class="form-control" id="dateRange" placeholder="Select date or range" readonly />
        </div>
        <div class="col-md-2 d-grid">
          <button class="btn btn-primary" onclick="applyFilters()">Filter</button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered mt-3 align-middle">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Project Title</th>
              <th>No. of Hours Worked</th>
              <th>Approval Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="workerTableBody"></tbody>
        </table>
      </div>

      <div class="mt-3 d-flex gap-2 flex-wrap">
        <button class="btn btn-success" onclick="showForm()">Add Entry</button>
        <button class="btn btn-warning" onclick="downloadWorkerExcel()">Download as Excel</button>
        <button class="btn btn-secondary ms-auto" onclick="goHome()">Logout</button>
      </div>
    </div>

    <!-- Form Page -->
    <div id="formPage" class="hide container">
      <h3 class="mb-3">Submit Work Entry</h3>
      <form id="entryForm" onsubmit="submitEntry(event)" novalidate>
        <div class="mb-3">
          <label for="entryDate" class="form-label">Date (today only)</label>
          <input
            type="date"
            class="form-control"
            id="entryDate"
            required
            aria-describedby="dateHelp"
            max=""
          />
          <div id="dateHelp" class="form-text">You can only submit entries for today's date.</div>
        </div>
        <div class="mb-3">
          <label for="role" class="form-label">Role</label>
          <input type="text" class="form-control" id="role" required />
        </div>
        <div class="mb-3">
          <label for="projectTitle" class="form-label">Project Title</label>
          <input type="text" class="form-control" id="projectTitle" required />
        </div>
        <div class="mb-3">
          <label for="description" class="form-label">Description of Work Completed</label>
          <textarea class="form-control" id="description" rows="3" required></textarea>
        </div>
        <div class="mb-3">
          <label for="hours" class="form-label">Hours Worked</label>
          <input type="number" class="form-control" id="hours" min="0" max="24" required />
        </div>
        <div class="mb-3">
          <label for="workStatus" class="form-label">Work Status</label>
          <select class="form-select" id="workStatus" required>
            <option value="" disabled selected>Select status</option>
            <option value="Completed">Completed</option>
            <option value="In Progress">In Progress</option>
            <option value="Pending Review">Pending Review</option>
          </select>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button type="submit" class="btn btn-success">Submit</button>
          <button type="button" class="btn btn-warning" onclick="downloadWorkerExcel()">Download as Excel</button>
          <button type="button" class="btn btn-secondary" onclick="backToWorker()">Cancel</button>
        </div>
      </form>
    </div>

    <!-- Manager Page -->
    <div id="managerPage" class="hide container">
      <h3 class="mb-3">Manager Dashboard</h3>
      <div class="table-responsive">
        <table class="table table-bordered mt-3 align-middle">
          <thead class="table-light">
            <tr>
              <th>Employee Name</th>
              <th>Date</th>
              <th>Hours</th>
              <th>Work Status</th>
              <th>Approval Status</th>
              <th>Action</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody id="managerTableBody"></tbody>
        </table>
      </div>

      <div class="mt-3 d-flex gap-2 flex-wrap">
        <button class="btn btn-success" onclick="approveAll()">Approve All</button>
        <button class="btn btn-warning" onclick="downloadExcel()">Download as Excel</button>
        <button class="btn btn-secondary ms-auto" onclick="goHome()">Logout</button>
      </div>
    </div>

    <!-- Modal for Viewing Details -->
    <div id="projectModal" class="modal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <h5 id="modalTitle" class="mb-3">Work Details</h5>
          <p><strong>Project Title:</strong> <span id="modalEmp"></span></p>
          <p><strong>Role:</strong> <span id="modalRole"></span></p>
          <p><strong>Work Status:</strong> <span id="modalWorkStatus"></span></p>
          <p><strong>Description:</strong> <span id="modalDesc"></span></p>
          <p><strong>Hours:</strong> <span id="modalHours"></span></p>
          <p><strong>Date:</strong> <span id="modalDate"></span></p>
          <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer from Code 1 -->
  <footer>
    <p>© 2025 Time Tracker App. All Rights Reserved.</p>
  </footer>

  <!-- Scripts -->
  <script>
    // === Initialize entries from localStorage or empty array
    let entries = JSON.parse(localStorage.getItem('entries') || '[]');

    // Set max date of date input to today
    function setMaxDate() {
      const todayStr = new Date().toISOString().split('T')[0];
      document.getElementById('entryDate').max = todayStr;
      document.getElementById('entryDate').value = todayStr; // default to today
    }

    // Setup Flatpickr for dateRange with mode range
    flatpickr("#dateRange", {
      mode: "range",
      dateFormat: "Y-m-d",
      allowInput: true,
    });

    // Function to switch views based on role
    function enterAs(role) {
      document.getElementById('landingPage').classList.add('hide');
      setMaxDate();
      if (role === 'worker') {
        showWorkerEntries();
        document.getElementById('workerPage').classList.remove('hide');
      } else {
        showManagerEntries();
        document.getElementById('managerPage').classList.remove('hide');
      }
    }

    // Show the Add Entry form
    function showForm() {
      document.getElementById('workerPage').classList.add('hide');
      setMaxDate();
      document.getElementById('formPage').classList.remove('hide');
    }

    // Back to worker dashboard
    function backToWorker() {
      document.getElementById('formPage').classList.add('hide');
      showWorkerEntries();
      document.getElementById('workerPage').classList.remove('hide');
    }

    // Submit new or edited entry
    function submitEntry(event) {
      event.preventDefault();

      const dateInput = document.getElementById('entryDate').value;
      if (!dateInput) {
        alert("Please select a date.");
        return;
      }

      // Only allow today's date
      const entryDate = new Date(dateInput);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      if (entryDate.toDateString() !== today.toDateString()) {
        alert("Only today's date is allowed.");
        return;
      }

      // Check duplicate date (for worker, only one entry per date)
      const existing = entries.find(e => e.date === dateInput && e.role === document.getElementById('role').value && e.projectTitle === document.getElementById('projectTitle').value);
      if (existing) {
        alert("Entry already submitted for today with this project and role.");
        return;
      }

      // Prepare new entry
      const newEntry = {
        id: Date.now(),
        date: dateInput,
        role: document.getElementById('role').value.trim(),
        projectTitle: document.getElementById('projectTitle').value.trim(),
        description: document.getElementById('description').value.trim(),
        hours: parseFloat(document.getElementById('hours').value),
        workStatus: document.getElementById('workStatus').value,
        approvalStatus: "Pending",
        employeeName: "Worker", // In real app, use actual user names
      };

      // Validation
      if (
        !newEntry.role ||
        !newEntry.projectTitle ||
        !newEntry.description ||
        isNaN(newEntry.hours) ||
        newEntry.hours <= 0 ||
        !newEntry.workStatus
      ) {
        alert("Please fill all required fields correctly.");
        return;
      }

      entries.push(newEntry);
      localStorage.setItem('entries', JSON.stringify(entries));
      alert("Entry submitted successfully.");
      backToWorker();
    }

    // Show worker entries filtered and render table
    function showWorkerEntries() {
      const tbody = document.getElementById('workerTableBody');
      tbody.innerHTML = "";

      // Apply filters
      const searchText = document.getElementById('searchProject')?.value?.toLowerCase() || "";
      const workStatusFilter = document.getElementById('filterWorkStatus')?.value || "";
      const approvalStatusFilter = document.getElementById('filterApprovalStatus')?.value || "";
      const dateRange = document.getElementById('dateRange')?.value || "";

      let filtered = entries.filter(e => e.role.toLowerCase() === "worker");

      if (searchText) {
        filtered = filtered.filter(e => e.projectTitle.toLowerCase().includes(searchText));
      }
      if (workStatusFilter) {
        filtered = filtered.filter(e => e.workStatus === workStatusFilter);
      }
      if (approvalStatusFilter) {
        filtered = filtered.filter(e => e.approvalStatus === approvalStatusFilter);
      }
      if (dateRange) {
        const dates = dateRange.split(" to ");
        if (dates.length === 2) {
          const start = new Date(dates[0]);
          const end = new Date(dates[1]);
          filtered = filtered.filter(e => {
            const d = new Date(e.date);
            return d >= start && d <= end;
          });
        } else if (dates.length === 1) {
          const d = new Date(dates[0]);
          filtered = filtered.filter(e => new Date(e.date).toDateString() === d.toDateString());
        }
      }

      if (filtered.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.className = "text-center text-muted";
        td.textContent = "No entries found.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      filtered.forEach(entry => {
        const tr = document.createElement('tr');

        // Date
        const tdDate = document.createElement('td');
        tdDate.textContent = entry.date;
        tr.appendChild(tdDate);

        // Project Title
        const tdTitle = document.createElement('td');
        tdTitle.textContent = entry.projectTitle;
        tr.appendChild(tdTitle);

        // Hours Worked
        const tdHours = document.createElement('td');
        tdHours.textContent = entry.hours;
        tr.appendChild(tdHours);

        // Approval Status
        const tdApproval = document.createElement('td');
        tdApproval.textContent = entry.approvalStatus;
        if (entry.approvalStatus === "Pending") {
          tdApproval.classList.add('text-warning');
        } else if (entry.approvalStatus === "Approved") {
          tdApproval.classList.add('text-success');
        }
        tr.appendChild(tdApproval);

        // Actions - No actions for worker entries yet (could add edit/delete later)
        const tdAction = document.createElement('td');
        tdAction.innerHTML = `<button class="btn btn-sm btn-danger" onclick="deleteEntry(${entry.id}, 'worker')">Delete</button>`;
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });
    }

    // Delete entry by id and role
    function deleteEntry(id, role) {
      if (!confirm("Are you sure you want to delete this entry?")) return;
      entries = entries.filter(e => e.id !== id);
      localStorage.setItem('entries', JSON.stringify(entries));
      if (role === "worker") {
        showWorkerEntries();
      } else if (role === "manager") {
        showManagerEntries();
      }
    }

    // Apply filters button click
    function applyFilters() {
      if (!document.getElementById('workerPage').classList.contains('hide')) {
        showWorkerEntries();
      }
    }

    // Show manager entries
    function showManagerEntries() {
      const tbody = document.getElementById('managerTableBody');
      tbody.innerHTML = "";

      if (entries.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 7;
        td.className = "text-center text-muted";
        td.textContent = "No entries available.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      entries.forEach(entry => {
        const tr = document.createElement('tr');

        // Employee Name
        const tdEmp = document.createElement('td');
        tdEmp.textContent = entry.employeeName;
        tr.appendChild(tdEmp);

        // Date
        const tdDate = document.createElement('td');
        tdDate.textContent = entry.date;
        tr.appendChild(tdDate);

        // Hours
        const tdHours = document.createElement('td');
        tdHours.textContent = entry.hours;
        tr.appendChild(tdHours);

        // Work Status
        const tdWorkStatus = document.createElement('td');
        tdWorkStatus.textContent = entry.workStatus;
        tr.appendChild(tdWorkStatus);

        // Approval Status
        const tdApproval = document.createElement('td');
        tdApproval.textContent = entry.approvalStatus;
        tdApproval.classList.add(entry.approvalStatus === "Approved" ? "text-success" : "text-warning");
        tr.appendChild(tdApproval);

        // Action (Approve/Reject toggle)
        const tdAction = document.createElement('td');
        if (entry.approvalStatus === "Pending") {
          tdAction.innerHTML = `<button class="btn btn-sm btn-success" onclick="toggleApproval(${entry.id}, true)">Approve</button> <button class="btn btn-sm btn-danger" onclick="toggleApproval(${entry.id}, false)">Reject</button>`;
        } else {
          tdAction.textContent = "-";
        }
        tr.appendChild(tdAction);

        // View button (shows modal)
        const tdView = document.createElement('td');
        const btnView = document.createElement('button');
        btnView.className = "btn btn-sm btn-primary";
        btnView.textContent = "View";
        btnView.onclick = () => showModal(entry);
        tdView.appendChild(btnView);
        tr.appendChild(tdView);

        tbody.appendChild(tr);
      });
    }

    // Toggle approval status for manager
    function toggleApproval(id, approve) {
      const index = entries.findIndex(e => e.id === id);
      if (index === -1) return;
      entries[index].approvalStatus = approve ? "Approved" : "Pending";
      localStorage.setItem('entries', JSON.stringify(entries));
      showManagerEntries();
      alert(`Entry ${approve ? 'approved' : 'set back to pending'}.`);
    }

    // Approve all pending entries
    function approveAll() {
      if (!confirm("Are you sure you want to approve all pending entries?")) return;
      entries = entries.map(e => {
        if (e.approvalStatus === "Pending") e.approvalStatus = "Approved";
        return e;
      });
      localStorage.setItem('entries', JSON.stringify(entries));
      showManagerEntries();
      alert("All pending entries approved.");
    }

    // Show modal with entry details
    function showModal(entry) {
      document.getElementById('modalEmp').textContent = entry.employeeName || "Worker";
      document.getElementById('modalRole').textContent = entry.role;
      document.getElementById('modalWorkStatus').textContent = entry.workStatus;
      document.getElementById('modalDesc').textContent = entry.description;
      document.getElementById('modalHours').textContent = entry.hours;
      document.getElementById('modalDate').textContent = entry.date;
      const modal = document.getElementById('projectModal');
      modal.style.display = "block";
      modal.setAttribute('aria-hidden', 'false');
    }

    // Close modal
    function closeModal() {
      const modal = document.getElementById('projectModal');
      modal.style.display = "none";
      modal.setAttribute('aria-hidden', 'true');
    }

    // Download worker's entries as Excel
    function downloadWorkerExcel() {
      const workerEntries = entries.filter(e => e.role.toLowerCase() === "worker");
      if (workerEntries.length === 0) {
        alert("No entries available to download.");
        return;
      }

      const wsData = [
        ["Date", "Project Title", "Hours Worked", "Approval Status"]
      ];
      workerEntries.forEach(e => {
        wsData.push([e.date, e.projectTitle, e.hours, e.approvalStatus]);
      });

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Worker Entries");

      XLSX.writeFile(wb, "Worker_Entries.xlsx");
    }

    // Download all entries as Excel (Manager)
    function downloadExcel() {
      if (entries.length === 0) {
        alert("No entries available to download.");
        return;
      }
      const wsData = [
        ["Employee Name", "Date", "Hours", "Work Status", "Approval Status"]
      ];
      entries.forEach(e => {
        wsData.push([e.employeeName, e.date, e.hours, e.workStatus, e.approvalStatus]);
      });

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Entries");

      XLSX.writeFile(wb, "All_Entries.xlsx");
    }

    // Logout and go back to landing page
    function goHome() {
      document.getElementById('workerPage').classList.add('hide');
      document.getElementById('formPage').classList.add('hide');
      document.getElementById('managerPage').classList.add('hide');
      document.getElementById('landingPage').classList.remove('hide');

      // Clear filters and search
      document.getElementById('searchProject').value = "";
      document.getElementById('filterWorkStatus').value = "";
      document.getElementById('filterApprovalStatus').value = "";
      document.getElementById('dateRange').value = "";
    }

    // Initialize max date on load
    window.onload = () => {
      setMaxDate();

      // Close modal on click outside content
      window.onclick = function(event) {
        const modal = document.getElementById('projectModal');
        if (event.target === modal) closeModal();
      };
    };
  </script>

</body>
</html>
